let audioContext,analyser,meydaAnalyzer,microphone,timerInterval,recordingSeconds=0;const progressBar=document.getElementById("analysis-progress"),rmsDisplay=document.getElementById("rms"),centroidDisplay=document.getElementById("centroid"),engagementDisplay=document.getElementById("engagement"),rmsCtx=document.getElementById("rmsChart").getContext("2d"),centroidCtx=document.getElementById("centroidChart").getContext("2d"),engagementCtx=document.getElementById("engagementChart").getContext("2d");const rmsChart=new Chart(rmsCtx,{type:"line",data:{labels:[],datasets:[{label:"RMS",data:[],borderColor:"cyan"}]},options:{responsive:!0}}),centroidChart=new Chart(centroidCtx,{type:"line",data:{labels:[],datasets:[{label:"Spectral Centroid",data:[],borderColor:"yellow"}]},options:{responsive:!0}}),engagementChart=new Chart(engagementCtx,{type:"line",data:{labels:[],datasets:[{label:"Engagement Score",data:[],borderColor:"lime"}]},options:{responsive:!0}});const WEIGHTS={rms:1.5,centroid:1.2,flux:1.3,zeroCrossing:.8};function startRecording(){navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{audioContext=new(window.AudioContext||window.webkitAudioContext),analyser=audioContext.createAnalyser(),microphone=audioContext.createMediaStreamSource(e),microphone.connect(analyser),meydaAnalyzer=Meyda.createMeydaAnalyzer({audioContext:audioContext,source:microphone,bufferSize:512,featureExtractors:["rms","spectralCentroid"],callback:updateMetrics}),meydaAnalyzer.start(),timerInterval=setInterval(updateTimer,1e3),document.getElementById("record-indicator").style.display="inline-block"})}function stopRecording(){meydaAnalyzer.stop(),clearInterval(timerInterval),document.getElementById("record-indicator").style.display="none",recordingSeconds=0,document.getElementById("timer").innerText="00:00"}function updateMetrics(e){const t=(WEIGHTS.rms*e.rms+WEIGHTS.centroid*(e.spectralCentroid/1e3)).toFixed(2);engagementDisplay.innerText=t,rmsDisplay.innerText=e.rms.toFixed(4),centroidDisplay.innerText=e.spectralCentroid.toFixed(2),updateChart(rmsChart,e.rms),updateChart(centroidChart,e.spectralCentroid),updateChart(engagementChart,t)}function updateChart(e,t){e.data.labels.push(new Date().toLocaleTimeString()),e.data.datasets[0].data.push(t),e.update()}function updateTimer(){recordingSeconds++,document.getElementById("timer").innerText=new Date(1e3*recordingSeconds).toISOString().substr(14,5)}function generateCSV(){const e=[];e.push(\"Time, RMS, Spectral Centroid, Engagement Score\"),rmsChart.data.labels.forEach((t,a)=>{const r=rmsChart.data.datasets[0].data[a],n=centroidChart.data.datasets[0].data[a],o=engagementChart.data.datasets[0].data[a];e.push(`${t}, ${r}, ${n}, ${o}`)});const t=\"data:text/csv;charset=utf-8,\"+e.join(\"\\n\"),a=encodeURI(t),r=document.createElement(\"a\");r.setAttribute(\"href\",a),r.setAttribute(\"download\",\"engagement_report.csv\"),document.body.appendChild(r),r.click(),document.body.removeChild(r)}function generatePDF(){const{jsPDF:e}=window.jspdf,t=new e;engagementChart&&t.text(\"Engagement Analysis Report\",10,10),t.save(\"engagement_report.pdf\")}
